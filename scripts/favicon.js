/*
 * Material You NewTab
 * Copyright (c) 2023-2025 XengShi
 * Licensed under the GNU General Public License v3.0 (GPL-3.0)
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

// Function to update the favicon
const updateFavicon = (hexColor) => {
    const faviconLink = document.querySelector("link[rel='icon']");

    // Check if cached version exists
    const cachedFavicon = localStorage.getItem(`favicon_${hexColor}`);
    if (cachedFavicon) {
        faviconLink.href = cachedFavicon;
        return;
    }

    // Fetch colors from CSS variables
    const rootStyles = getComputedStyle(document.documentElement);
    const darkColor = rootStyles.getPropertyValue("--darkColor-blue");
    const bgColor = rootStyles.getPropertyValue("--bg-color-blue");

    // Construct the SVG string with dynamic colors
    const svgTemplate = `
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 1650 1650">
            <path
        d="M825 0h2.31c18.98.05 36.88 2.89 54.75 9.38l3.72 1.33c23.41 8.9 43.78 22.74 61.22 40.67 23.96 24.52 55.78 39.3 89.06 46l3.61.75c25.16 4.25 50.83 1.06 75.36-4.95 12.42-3.01 24.64-4.2 37.41-4.18h2.09c36.77.13 72.06 12.46 101.53 34.38l2.66 1.97c30.94 24.18 49.98 55.98 60.66 93.4 7.79 27.07 22.62 50.18 41.68 70.63l2.12 2.27c20.24 21.06 47.31 34.24 74.88 42.73 12.95 4.03 25.14 8.39 37 15l1.88 1.02c39.25 21.5 67.18 59.6 80.12 101.98 8.57 32.14 7.69 63.81-.2 95.96-2.98 12.35-4.16 24.47-4.11 37.16l.01 2.04c.05 11.51.85 22.58 3.3 33.84l.51 2.36c6.99 31.85 23.82 61.82 47.37 84.39 30.44 29.95 46.08 73.19 46.55 115.34.24 46.58-16.95 87.93-48.43 121.91l-4.68 4.62c-29.97 29.42-44.72 73.63-45.57 114.88.35 17.05 3.35 33.45 7.33 49.98 3.44 14.48 5.82 29.59 4.92 44.52l-.12 2.13c-2.38 37.61-15.69 74.43-40.88 102.87l-1.33 1.53c-11.65 13.34-24.65 24.11-39.67 33.47l-3.25 2.08c-14.04 8.55-29.72 13.85-45.43 18.42-22.2 6.49-42.99 17.05-60.32 32.5l-2.57 2.24-7.43 6.76-2.17 1.96c-23.35 22.13-35.8 51.3-44.83 81.52-13.28 43.74-44.5 78.91-84.34 100.65-39.78 20.74-82.88 22.45-125.66 11.87-44.91-11.02-90.29-3.15-130 20-4.51 2.75-8.79 5.78-13 9l-2.84 2.17c-4.86 3.84-9.32 7.91-13.66 12.33-23.66 24.06-52.93 38.63-85.5 46.5l-2.24.54c-40.95 9.38-86.52-.16-122.26-21.29-12.61-7.94-23.62-17.65-34.31-27.97-24.97-23.65-57.95-39.92-92.19-44.28l-1.92-.28c-25.63-3.32-50.41.6-75.35 6.21-43.05 9.61-88.9-.1-126.04-23.38-9.7-6.36-18.4-13.45-26.69-21.55l-2.98-2.8c-22.61-21.46-35.87-48.93-44.33-78.58-7.8-27.07-22.62-50.18-41.69-70.62l-2.11-2.28c-19.44-20.22-46.28-34.66-73.13-42.23-19.41-5.49-38.59-13.18-54.76-25.49-.06-.78-2.12-1.55-3.22-2.34-20.65-15.31-36.06-34.52-48.78-56.66l-1.97-3.42c-19.16-35.77-22.5-78.43-14.03-117.58l.67-3.11 2.67-12.15c9.58-41.89-.82-86.82-22.98-122.95-7.85-12.27-17.64-23.5-28.23-33.48C16.63 913.36.13 871.06-.18 831.19c-.08-28.31-.08-28.31 3.24-41.81l.62-2.55c3-12.02 6.94-23.34 12.38-34.45l1-2.08c7.44-15.39 17.31-28.49 29-40.92l6.98-7.62 6.15-6.62c29.4-31.53 41.3-76.5 40.02-118.65-.69-14.58-3.76-28.75-7.08-42.93l-.76-3.27-.69-2.88c-8.46-41.66 2.75-87.55 25.9-122.54 4.44-6.47 9.37-12.56 14.48-18.49l2.56-2.97c10.62-12.07 22.81-21.58 36.44-30.03l1.89-1.18c13.58-8.4 28.19-13.9 43.51-18.26 9.71-2.77 18.75-6.19 27.85-10.56l3.07-1.48c39.35-19.51 70.02-54.82 84.34-96.32 1.35-4.14 2.56-8.32 3.78-12.49 13.4-45.59 42.5-81.01 83.76-104.35 24.61-13.4 51.74-19.59 79.61-19.61l2.38-.01c16.81.03 31.91 2.5 48.2 6.48 43.42 10.47 88.51 1.13 126.61-21.22 10.27-6.38 19.05-14.31 27.72-22.66C736.61 19.19 777.53-.12 825 0z"
                fill="${bgColor}" />
            <path
                d="M589.19 355.69h2.44c12.99.05 25.6.8 38.37 3.31l2.31.44c5.28 1.02 10.49 2.25 15.69 3.56l2.48.62c18.12 4.61 34.58 11.81 51.21 20.26C752.85 409.8 812.82 425.95 870 412l3.2-.76c27.81-6.75 54-17.53 79.43-30.55 32.64-16.66 67.95-25.17 104.56-25h2.44c12.99.05 25.6.8 38.37 3.31l2.31.44c5.28 1.02 10.49 2.25 15.69 3.56l2.48.62A223.33 223.33 0 0 1 1194 399l1.7 1.23c7.3 5.33 14.06 11.12 20.65 17.31a139.1 139.1 0 0 0 6.47 5.65c3.82 3.25 6.95 6.98 10.18 10.81l2.47 2.81c29.01 33.18 47.32 73.81 54.53 117.19l.69 3.87c6.88 46.46-2.37 96.45-23.61 138.01-3.23 6.35-6.22 12.82-9.22 19.28l-2.19 4.62C1234.26 765.11 1223.6 820.61 1236 870l.83 3.32c7.46 29.04 18.69 56.38 32.42 83 10.55 20.58 16.82 42.98 20.75 65.68l.69 3.89c7.08 48.16-3.09 99.38-25.69 142.11l-1.07 2.04c-8.9 16.71-20 31.61-32.74 45.58-1.98 2.16-3.87 4.35-5.75 6.57-3.51 4.01-7.37 7.39-11.44 10.81l-2.83 2.5c-30.98 27.12-70.64 46.19-111.17 53.5l-3.15.59c-45.84 7.82-97.23 1.65-138.85-19.59l-10.62-5.37-2.86-1.45c-9-4.49-18.18-8.43-27.52-12.18l-3.29-1.35c-15.72-6.29-32.1-11.35-48.71-14.65l-2.09-.45c-13.27-2.8-26.65-2.86-40.16-2.92l-2.71-.03c-12.04-.08-23.27.93-35.04 3.4l-5.74 1.07c-27.96 5.6-54.07 16.16-79.46 29.02-13.09 6.62-26.2 12.27-40.17 16.79l-3.46 1.12c-52.84 16.57-116.65 12.53-166.17-13l-2.33-1.16c-11.75-5.89-23.02-12.12-33.67-19.84l-1.7-1.23c-7.3-5.33-14.06-11.12-20.65-17.3a133.19 133.19 0 0 0-6.46-5.65c-3.82-3.25-6.96-6.99-10.19-10.82l-2.5-2.84c-27.11-30.98-46.18-70.63-53.5-111.16l-.58-3.15c-7.82-45.84-1.65-97.23 19.58-138.85l5.38-10.62 1.44-2.86c4.5-9 8.44-18.18 12.18-27.52l1.36-3.29c6.07-15.18 11.08-30.99 14.13-47.02l1.27-6.22c2.28-11.04 2.71-21.79 2.63-33.04l.02-8.77c.02-11.56-.99-22.36-3.41-33.66l-1.07-5.74c-5.6-27.96-16.15-54.1-29.01-79.46-6.63-13.09-12.27-26.2-16.79-40.17l-1.12-3.46C348.43 603.33 352.47 539.52 378 490l1.17-2.33c5.89-11.75 12.11-23.02 19.83-33.67l1.23-1.7c5.33-7.3 11.12-14.06 17.31-20.65 1.96-2.1 3.82-4.24 5.65-6.46 3.25-3.82 6.98-6.96 10.81-10.19l2.81-2.46c42.06-36.78 96.58-57.11 152.38-56.85z"
                fill="#FFFFFF"  />
            <path
                d="M842.16 565.33c6.57 4.85 12.4 10.77 18.33 16.38a283.86 283.86 0 0 0 9.49 8.52c2.71 2.38 5.37 4.82 8.02 7.27l10 9c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.93 3.4 7.75 6.93 11.58 10.45l8.42 7.55c3.39 2.94 6.7 5.96 10 9l12.02 10.76L1062 763l5 4.5 32.47 29.23 5.28 4.69 2.69 2.39 2.43 2.15c3.97 3.81 5.96 6.75 6.38 12.37-.45 6.56-3.37 10.4-8.25 14.67-3.18 1.06-5.42 1.12-8.76 1.11h-3.58c-1.27 0-2.55-.01-3.86-.01l-3.95-.01a3612.29 3612.29 0 0 1-10.41-.02l-10.61-.02L1046 834l.01 3.55.19 83.46.02 10.28v2.07l.09 33.1.07 33.99.04 19.08.03 17.97.03 6.59v9.01l.04 2.61c-.1 9.79-3.76 17.36-10.44 24.38-7.52 6.9-15.71 8.21-25.55 8.18l-3.15.02-10.31.01-7.18.01h-15.05l-19.25.04-14.83.01-7.1.02a1643.42 1643.42 0 0 1-9.93-.01l-2.95.02c-9.4-.06-16.79-2.74-23.79-9.26-9.71-10.05-10.58-20.92-10.44-34.34l-.01-4.83.05-12.99.04-13.62.08-25.74.1-34.82L887 898H760l.11 35.81.04 22.45.08 35.64.05 25.95.04 13.74.02 12.95.02 4.74c.08 11.52-.62 20.86-9.15 29.54-8.57 7.91-16.73 9.33-28.09 9.32l-3 .01-9.82.02-6.85.01h-14.34l-18.34.03-14.14.02-6.76.01h-9.47l-2.8.02c-11.01-.06-19.17-2.29-27.36-9.89-6.55-7.09-8.85-14.69-8.72-24.19l-.01-2.85.04-9.47-.01-6.8.05-18.42.04-19.26.07-32.33.08-33.28v-2.07l.02-10.31.2-85.39-2.24.02-20.92.19-10.75.09-10.39.08-5.87.07c-11.14 0-11.14 0-15.83-4.45-3.44-4.61-4.69-8.11-4.38-13.88 1.53-8.64 11.77-15.68 18.11-21.14 2.8-2.45 5.54-4.96 8.27-7.48l11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.87-10.63 8.13-7.37 11.94-10.69 7.56-6.81 9.44-8.44c3.95-3.43 7.79-6.97 11.64-10.51 3.38-3.12 6.81-6.17 10.29-9.17 2.23-1.97 4.39-4 6.55-6.03 13.82-12.93 29.06-19.42 46.74-8.52z"
                fill="${darkColor}"  />
        </svg>
   `;

    // Convert SVG to a Data URL
    const svgDataUrl = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgTemplate)))}`;

    // Set the new favicon
    faviconLink.href = svgDataUrl;

    // Remove previous cached favicons
    Object.keys(localStorage).forEach((key) => {
        if (key.startsWith("favicon_")) {
            localStorage.removeItem(key);
        }
    });

    // Store the new favicon
    localStorage.setItem(`favicon_${hexColor}`, svgDataUrl);
};